```mermaid
graph TD
    %% ================= 样式定义 (参考上传图片的配色) =================
    %% 基础样式
    classDef base font-family:Arial,font-size:14px;
    
    %% 节点样式
    classDef startNode fill:#e8f5e9,stroke:#4caf50,stroke-width:2px,rx:5,ry:5,color:#1b5e20;     %% 绿色: 开始/结束
    classDef processNode fill:#e3f2fd,stroke:#2196f3,stroke-width:1px,rx:2,ry:2,color:#0d47a1;   %% 蓝色: 处理过程
    classDef decisionNode fill:#fff9c4,stroke:#fbc02d,stroke-width:1px,shape:diamond,rx:5,ry:5,color:#f57f17; %% 黄色: 判断
    classDef errorNode fill:#ffebee,stroke:#ef5350,stroke-width:1px,rx:2,ry:2,color:#b71c1c;     %% 红色: 报错/Revert

    %% ================= 子图 1: 用户领取流程 (Claim) =================
    subgraph UserFlow [核心流程: 用户领取空投]
        direction TB
        
        %% --- 节点定义 ---
        Start((开始: 用户调用 claim)):::startNode
        
        %% 检查阶段
        CheckCool{是否在冷却中?}:::decisionNode
        ErrCool[Revert: Cooldown active]:::errorNode
        
        CheckFee{BNB 费用足够?}:::decisionNode
        ErrFee[Revert: Insufficient fee]:::errorNode
        
        %% 逻辑阶段
        CheckRef{需绑定推荐人?<br>无上线且输入有效}:::decisionNode
        BindRef[绑定推荐人<br>inviteCount++]:::processNode
        UpdateState[更新领取时间戳]:::processNode
        
        %% 资金阶段
        TransBNB[转账 BNB 给 feeRecipient]:::processNode
        CheckTrans{转账成功?}:::decisionNode
        ErrTrans[Revert: Transfer failed]:::errorNode
        
        %% 奖励阶段
        CalcReward[计算随机数量<br>minReward ~ maxReward]:::processNode
        CheckBal{合约代币充足?}:::decisionNode
        ErrBal[Revert: Contract empty]:::errorNode
        SendToken[发送代币给用户<br>Emit Claimed]:::processNode
        
        %% 推荐奖阶段
        CheckHasRef{是否有上线?}:::decisionNode
        CalcBonus[计算 10% 佣金]:::processNode
        CheckBonusBal{余额够发佣金?}:::decisionNode
        SendBonus[发送奖励给上线<br>Emit ReferralReward]:::processNode
        
        End((流程结束)):::startNode

        %% --- 连线逻辑 (主线垂直，支线向右) ---
        Start --> CheckCool
        
        CheckCool -- 是 --> ErrCool
        CheckCool -- 否 --> CheckFee
        
        CheckFee -- 否 --> ErrFee
        CheckFee -- 是 --> CheckRef
        
        CheckRef -- 是 --> BindRef --> UpdateState
        CheckRef -- 否 --> UpdateState
        
        UpdateState --> TransBNB --> CheckTrans
        
        CheckTrans -- 否 --> ErrTrans
        CheckTrans -- 是 --> CalcReward --> CheckBal
        
        CheckBal -- 否 --> ErrBal
        CheckBal -- 是 --> SendToken --> CheckHasRef
        
        CheckHasRef -- 无 --> End
        CheckHasRef -- 有 --> CalcBonus --> CheckBonusBal
        
        CheckBonusBal -- 否 --> End
        CheckBonusBal -- 是 --> SendBonus --> End
    end

    %% ================= 子图 2: 管理员流程 =================
    subgraph OwnerFlow [辅助流程: 管理员操作]
        direction TB
        O_Start((管理员调用)):::startNode
        O_Check{权限检查<br>onlyOwner}:::decisionNode
        O_Err[Revert: Unauthorized]:::errorNode
        O_Select{功能路由}:::decisionNode
        
        %% 功能分支
        Act1[setFee:<br>修改 BNB 门票费]:::processNode
        Act2[setRewardRange:<br>修改随机区间]:::processNode
        Act3[withdrawTokens:<br>提取剩余代币]:::processNode
        
        O_End((完成)):::startNode

        O_Start --> O_Check
        O_Check -- 否 --> O_Err
        O_Check -- 是 --> O_Select
        
        O_Select --> Act1 --> O_End
        O_Select --> Act2 --> O_End
        O_Select --> Act3 --> O_End
    end

    %% 调整子图间距
    style UserFlow fill:#ffffff,stroke:#999,stroke-dasharray: 5 5
    style OwnerFlow fill:#ffffff,stroke:#999,stroke-dasharray: 5 5
```