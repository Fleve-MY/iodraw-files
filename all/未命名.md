```mermaid
graph TB
    %% 定义样式类，参考了上传图像的蓝白色调
    classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:1px,color:#0d47a1,rx:5,ry:5;
    classDef decision fill:#b3e5fc,stroke:#0288d1,stroke-width:1px,color:#01579b,shape:diamond,rx:5,ry:5;
    classDef endNode fill:#ffcdd2,stroke:#c62828,stroke-width:1px,color:#b71c1c,rx:5,ry:5;
    classDef startNode fill:#c8e6c9,stroke:#2e7d32,stroke-width:1px,color:#1b5e20,rx:5,ry:5,shape:hexagon;

    %% ================= 用户核心流程 (claim) =================
    subgraph UserFlow [用户核心流程 (claim)]
        direction TB
        StartClaim((用户调用 claim\n支付 BNB)):::startNode --> GuardCheck{防重入检查\nnonReentrant};
        GuardCheck -- 通过 --> CheckCooldown{判断: 冷却时间是否结束?\n(4 hours)};
        
        CheckCooldown -- 否 (冷却中) --> RevertCooldown[Revert: Cooldown active]:::endNode;
        CheckCooldown -- 是 --> CheckFee{判断: BNB 费用是否足够?\n(>= claimFee)};
        
        CheckFee -- 否 --> RevertFee[Revert: Insufficient BNB fee]:::endNode;
        CheckFee -- 是 --> CheckBind{判断: 是否需绑定推荐关系?\n(无上线且输入有效)};
        
        CheckBind -- 需要绑定 --> BindReferrer[更新状态: 绑定推荐人\n增加上线邀请计数]:::process;
        CheckBind -- 不需要 --> UpdateTime[更新状态: 记录本次领取时间]:::process;
        BindReferrer --> UpdateTime;
        
        UpdateTime --> TransferBNB[外部调用: 发送 BNB 给 feeRecipient]:::process;
        TransferBNB --> CheckBNBSuccess{判断: BNB 转账是否成功?};
        
        CheckBNBSuccess -- 失败 --> RevertBNB[Revert: BNB Transfer failed]:::endNode;
        CheckBNBSuccess -- 成功 --> CalcReward[计算: 生成随机基础奖励量\n(minReward ~ maxReward)]:::process;
        
        CalcReward --> CheckTokenBalance{判断: 合约代币余额是否充足?};
        CheckTokenBalance -- 不足 --> RevertBalance[Revert: Contract empty]:::endNode;
        CheckTokenBalance -- 充足 --> TransferReward[代币转账: 向用户发送基础奖励]:::process;
        
        TransferReward --> EmitClaimed[事件: 触发 Claimed]:::process;
        EmitClaimed --> CheckHasReferrer{判断: 用户是否有绑定上线?};
        
        CheckHasReferrer -- 无 --> EndClaim((流程结束)):::startNode;
        CheckHasReferrer -- 有 --> CalcBonus[计算: 10% 额外推荐奖励]:::process;
        
        CalcBonus --> CheckBonusBalance{判断: 合约余额够发额外奖励吗?};
        CheckBonusBalance -- 不足 (跳过奖励) --> EndClaim;
        CheckBonusBalance -- 充足 --> TransferBonus[代币转账: 向推荐人发送额外奖励]:::process;
        TransferBonus --> EmitBonus[事件: 触发 ReferralReward]:::process;
        EmitBonus --> EndClaim;
    end

    %% ================= 管理员操作流程 =================
    subgraph OwnerFlow [管理员操作流程 (onlyOwner)]
        direction TB
        StartOwner((管理员调用管理函数)):::startNode --> AuthCheck{权限检查\nonlyOwner};
        AuthCheck -- 非管理员 --> RevertAuth[Revert: caller is not the owner]:::endNode;
        AuthCheck -- 验证通过 --> FunctionSelect{功能选择};
        
        FunctionSelect -- setFee --> SetFeeAction[更新状态: 设置新的领取费用 BNB]:::process;
        FunctionSelect -- setRewardRange --> SetRangeAction[更新状态: 设置新的奖励区间 min/max]:::process;
        FunctionSelect -- withdrawTokens --> WithdrawAction[代币转账: 提取合约内剩余 ERC20 代币]:::process;
        
        SetFeeAction --> EndOwner((管理操作结束)):::startNode;
        SetRangeAction --> EndOwner;
        WithdrawAction --> EndOwner;
    end

    %% 应用样式
    class GuardCheck,CheckCooldown,CheckFee,CheckBind,CheckBNBSuccess,CheckTokenBalance,CheckHasReferrer,CheckBonusBalance,AuthCheck,FunctionSelect decision;
    
    %% 连接两个子图的视觉提示（可选）
    EndOwner -.-> StartClaim
    style UserFlow fill:#fcfdfe,stroke:#b3e5fc,stroke-width:2px
    style OwnerFlow fill:#fcfdfe,stroke:#b3e5fc,stroke-width:2px

```